# 2022_takenaka_IMAGE-Conv_TestApp

竹中製作所 映像変換装置 検査用アプリ（Windows）

# 映像変換装置検査用アプリケーション
Ethernet-HOTLink変換装置の動作確認用の検査治具装置と組合せて使用する検査用アプリケーション。
検査用治具装置はRGB-HOTLink変換装置も共用だが、RGB-HOTLink変換はHWのみで検証を行うため検査用アプリケーションでの対応は必要ない。

## 検査用アプリケーション仕様
### 構成
* Windows向けのコンソールアプリケーションとして作成する。
    * アプリケーション名「ImageConverterCheckTest.exe」。
    * 開発言語は Visual C++を使用する。
* WindowsのコマンドプロンプトもしくはPowerShellなどから手動で起動。
* メッセージなどはコンソールに表示、また起動フォルダにログファイルを生成し記録する。

### 機能
#### 検査動作
1. アプリケーションの起動と初期化処理。
    * 起動時に設定ファイルを読み込み。
1. ソノブイ信号の生成と送信。
    * Ethernet-HOTLink変換装置に接続。
    通信エラーなどで接続が切れた場合は再接続処理を行い動作を継続する。
    * 100msごとに以下の処理を実行。
        1. 擬似ソノブイ信号のデータを生成。
            * 固定データ（0、-1、32767、-32768）
            * 乱数（C++ では std::mt19937 を使用する）
                * seedの初期値を設定値に記述し常に同じ乱数でテスト。
                * 設定のseed値が0の場合は std::random_device を使用し生成する。
        1. 生成したソノブイ信号をEthernet-HOTLink変換装置に送信。
            * 送信したソノブイ信号（を生成したseed値）を記録し、データ受信と比較スレッドに渡す。
1. 検証用治具からのデータ受信と比較。
    * 検証用治具からの通信を受信するサーバを起動。
    通信エラーなどで接続が切れた場合は再受信処理を行い動作を継続する。
    * 受信データと送信済データの内容を比較し、不一致の場合にエラーメッセージを表示・記録する。
    * Ethernet-HOTLink変換装置ではエラー発生時にソノブイ信号を破棄したり、前回のデータを複製して送ったりするため受信データにズレが発生する場合がある。
    ズレが発生したときに延々とエラーにならず、ズレを補正できように処理する。
1. 終了処理
    * Quit
    コマンドの入力でプログラムを終了する。
    * 送信データの応答が返るまで終了を待つ（送出ブロック数x100ms+αでタイムアウトする）。

「ソノブイ信号の生成と送信処理」と「検査用治具からのデータ受信と比較」は別スレッドで動作させる。

#### 異常検査機能
検査用アプリで異常状態を発生し、実際の環境で発生するEthernet-HOTLink映像変換装置のエラー対応を確認可能とする。

* ソノブイ信号データの変更
内部で記録するデータと実際に送信するデータを数百回に一度のタイミング（ランダム）に変更し、通信エラーを検出できているかを確認。
* ソノブイ信号通信間隔の調整
100ms間隔で送信するソノブイ信号の送信間隔を90～110ms程度の範囲で変更し、長時間のデータの過不足に対する動作を確認。
* 通信エラーの発生
以下のエラーを適切なタイミングで発生させることで、通信エラー時の対応を確認する。
    * 通信データを数バイト少く送る、また多めに送信する。
    * ソノブイ送信の間隔を150～500ms開ける。
    * １ブロックのデータを間欠的に間を開けて送信する。
    * ブロック送信の間や、送信中にTCPのコネクションを切断し再接続する。
* その他、物理的にLANケーブルを抜くなどの方法でエラーを発生させる。

#### メッセージの表示
以下のメッセージをコンソール画面に表示、またログに記録する。

* プログラムの起動、終了
* Ethernet-HOTLink変換装置への接続、検査用治具からの接続
* 送信データと受信データの不一致
* エラーのない場合に一切メッセージが表示されないと正常に動作しているか不明なため、60秒間隔でデータ正常と処理数を表示する。


### 設定
検査用アプリケーションと同じフォルダに設定ファイルを置き、起動時に設定を読み込む。
設定を変更した場合には、アプリケーションを再起動し、設定変更を有効にする。
* 設定項目
    * Ethernet-HOTLink変換装置のIPアドレスおよび接続ポート番号。
    * 検査用治具装置からの通信を待ち受けるポート番号。
    * ソノブイ信号を生成させる乱数のseedの初期値。
* 装置のIPアドレスなどの設定は、使用するPCの設定による。


<br><br>

## 基本機能
### 用語
この資料では以下の意味で用語を使用する。
* ソノブイ信号
ソノブイ模擬装置または検査用アプリケーションから映像変換装置に送られるデータ。
* フレーム（ソノブイ信号）
ソノブイ信号の CH1～CH8（2byte×8CH）をひとまとまりにしたデータ。
HOTLink信号はフレーム単位でパケット化して伝送する。
* ブロック（ソノブイ信号）
ソノブイ信号15625フレームをひとまとまり（250000byte）にしたデータ。
ソノブイ模擬装置からのソノブイ信号はブロック単位が10Hzの周期で間欠的に送られる。

### 検査手順
1. Ethernet-HOTLink変換装置のHOTLink出力と治具のHOTLink入力を接続する。
1. 検査用PCおよびEthernet-HOTLink変換装置と治具をEthernetで接続する。
1. PCで検査アプリケーションを立ち上げテストを行う。

#### Ethernet-HotLink変換装置
* Ethernetからソノブイ信号に相当するデータを定期的に受信しHOTLink信号に変換し伝送する。
* 通信エラーやその他の理由で正しい間隔でソノブイ信号を受信できない場合には、直前に受信したでーたをHOTLLink信号として伝送する。
* 通信状態、通信エラーなどをLOGに記録し外部から参照可能とする。

#### 映像変換検査治具
* HOTLinkからHOTLink信号に変換されたソノブイ信号を受信し、１ブロック単位で検査用アプリケーションに送信する。
* HOTLink伝送のエラーを検出する場合には、エラー内容を検査用アプリケーションに通知する。

### 検査用アプリケーション
* 擬似のソノブイ信号を生成し、100msごとにEthernet-HOTLink変換装置に送信する。
* 映像変換検査治具からソノブイ信号を受信し、送信したソノブイ信号と比較する。
比較した結果が送信データと異なっていた場合にはエラーとして画面に表示およびログに記録する。
